<script>

$(document).ready(function() {
    $( '#jwcheck_Hours' ).attr('checked', false)

    $( "#filter_username" ).autocomplete({
      source: "{{ path('user_search', {'access': 'ajax'}) }}",
      minLength: 2,
      select: function( event, ui ) {
        $( "#filter_username" ).val(ui.item.label);
        $( "#filter_userid" ).val(ui.item.userid);
      }
     });
})

/*
 * This will be kinda spectacular, maybe.
 * It'll pull a form with all the filtering and grab a new job list
 * based on it.
 */
function grabJobList() {
    bare_url = "{{ path('jobsview_jobs')}}";
    filtersFormData = $( "#filtersForm" ).serialize();
    url = bare_url + "?" + filtersFormData;
    $.get(url, function( data ) {
        $( "#jobsView" ).html(data);
      }).done( function( cont, textStatus, xhr ) {
        $( "#jobsViewTable" ).dataTable({
            "order": [[ 1, "asc" ]],
            "paging": false,
            "searching": true
            });
        $( ".jwHours" ).hide();
    });
    return false;
}

function countJobsList() {
    list = get_selected_jobs();
console.log(list.length);
    $( "#jobs_selected_count").text("Selected: " + list.length);
}

function select_all_jobs(value) {
    $(".jobs_list_checkbox").prop('checked', value);
    countJobsList();
}

function get_selected_jobs() {
    list = [];
    $(".jobs_list_checkbox").each(function(index, box) {
        if ($(box).prop('checked') == true) {
            list.push(box.value);
        }
    });
    return list;
}

function setStateOnSelectedJobs() {
    url = "{{ path('jobs_state') }}";
    slist = get_selected_jobs();
    state = $( "#jobStateSelect option:selected" ).val();
    data = {'jobs': slist, 'state': state};

    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        url: url,
        data: data,
        type: "POST",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            grabJobList();
      }).fail(function(xhr, status, error) {
            errmsg = "Failed changing state\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}

function releaseSelectedJobs() {
    url = "{{ path('jobs_release') }}";
    slist = get_selected_jobs();
    data = { 'jobs': slist };

    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        url: url,
        data: data,
        type: "POST",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            grabJobList();
      }).fail(function(xhr, status, error) {
            errmsg = "Failed changing state\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}

function moveJobs() {
    mlist = {};
    $(".move_job_to option:selected").each(function(index, box) {
        if (box.value > 0) {
            mlist[box.parentNode.name] = (box.value);
        }
    });
    if (!Object.keys(mlist).length) {
        return false;
    }

    url = "{{ path('jobs_move') }}";
    data = {'moves': mlist};
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        url: url,
        data: data,
        type: "POST",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            grabJobList();
      }).fail(function(xhr, status, error) {
            errmsg = "Failed changing state\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}

function checkChecked(classname)
{
    if ($( "#jwcheck_" + classname ).is(":checked")) {
        $( ".jw" + classname ).show();
    } else {
        $( ".jw" + classname ).hide();
    }
}

function printTableContent()
{
    $("header").hide();
    // This may be a bit specific for my designs,
    document.body.style.paddingTop = "0px";
    $("#jwfilters").hide();
    $("#jobsViewTable_info").hide();
    $("#jobsViewTable_filter").hide();
    $(".jwSelect").hide();
    window.print();
    document.body.style.paddingTop = "";
    $("#jwfilters").show();
    $("#jobsViewTable_info").show();
    $("#jobsViewTable_filter").show();
    $(".jwSelect").show();
    $("header").show();
}

</script>
