{% include 'CrewCallBundle:job:handling.html.twig' %}
{% include 'CrewCallBundle:shiftorganization:handling.html.twig' %}
<table id="shiftTable" class="table table-striped table-sm">
 {% for event in events %}
    <thead>
        <tr>
            <th>{{ event.name }}</th>
            <th colspan="3">&nbsp;</th>
        </tr>
    </thead>
    <tbody>
    {% for shift in event.shifts %}
        <tr>
            <td data-order="{{ shift.start | date('U')}}" >
                {{ shift.start|date('d M H:i') }}
                <span class="glyphicon glyphicon-arrow-right"></span> 
                {%  if shift.end | date('Y-m-d') == shift.start | date('Y-m-d') %}
                {{ shift.end|date('H:i') }}
                {% else %}
                    {{ shift.end | date('d M H:i') }}
                {% endif %}
            <td>
            {{ shift.function }}
            <a href="#" id="popSummary_event_{{ shift.event.id }}{{ shift.id }}" data-toggle="popover" data-html="true" onClick="popSummary('event', {{ shift.event.id }}, {{ shift.id }});"><span style="font-size: 15px" class="glyphicon glyphicon-info-sign"></span></a>
            </td>

            <td>
            {% set amounts = shift.jobsamountbystate %}
            <span class="ccAmount ccNeeded">{{ shift.amount }}</span>
            <span class="ccAmount ccConfirmed">{{ amounts.CONFIRMED }}</span>
            <span class="ccAmount ccAssigned">{{ amounts.ASSIGNED }}</span>
            <span class="ccAmount ccInterested">{{ amounts.INTERESTED }}</span>
            {% if shift.registeredamount > 0 %}
            {# TODO: Toggle + and - #}
            <a href="#" onClick="grabJobList({{ shift.id }});"><span id="plus_job_list_{{ shift.id }}" class="glyphicon glyphicon-plus" /></a>
            <a href="#" onClick="hideJobList({{ shift.id }});"><span id="minus_job_list_{{ shift.id }}" class="collapse glyphicon glyphicon-minus" /></a>
            {% endif %}
            </td>
            <td>
            {# TODO: Make it float besides the hamburger, not over #}
            {% if shift.event.state == "CONFIRMED" and shift.state != "CONFIRMED" %}
            <form action="{{ path('shift_state', { 'id': shift.id }) }}" method="POST">
            <input type="hidden" name="event" value="{{ shift.event.id }}">
            <input type="hidden" name="state" value="CONFIRMED">
            <input type="submit" value="Confirm">
            </form>
            {% endif %}

            <div class="dropdown">
              <button class="glyphicon glyphicon-menu-hamburger" id='actionburger' type="button" data-toggle="dropdown">
              <span></span>
              </button>
            <ul class="dropdown-menu dropdown-menu-right">
              <li><a href="#" onClick="grabJobList({{ shift.id }});">Jobs</a></li>
              <li><a href="#" onClick="grabEditShiftForm({{ shift.id }});">Edit</a></li>
              <li><a href="#" onClick="grabJobList({{ shift.id }}); grabNewJobForm({{shift.id}});">Add person</a></li>
              <li><a href="#" onClick="grabJobList({{ shift.id }}); grabNewShiftOrganizationForm({{shift.id}});">Add crew from an organization</a></li>
    {% set mlogcontext = {
                'system': 'crewcall',
                'object_name': 'shift',
                'external_id': shift.id
        }
    %}
    {% if sakonnin_messages.contexthasmessages(mlogcontext) %}
             <li><a href="#" onClick="openMessageLogBox('{{ path('message_context_search', {'access': 'ajax', 'system': mlogcontext.system, 'object_name': mlogcontext.object_name, 'external_id': mlogcontext.external_id }) }}')">Notes</a></li>
    {% endif %}
    {% set mconf = {'mconfig': {
            'formname': 'shiftnote_' ~ shift.id,
            'reload_after_post': true,
            'subject': "",
            'to_field': false,
            'from_field': false,
            'to_type': "NONE",
            'from_type': "NONE",
            'message_type': 'Notes',
            'context': {
                'system': 'crewcall',
                'object_name': 'shift',
                'external_id': shift.id
                }
            }
        }
    %}
    {% include 'BisonLabSakonninBundle:Message:_create_popup.html.twig' with mconf %}
            <li><a href="#" onClick='createMessage("shiftnote_{{ shift.id }}");'>Add a note</a></li>
    {% set mconf = {'mconfig': {
            'formname': 'shiftconfirmcheck',
            'reload_after_post': true,
            'message_type': 'ConfirmCheck',
            'submit': 'Save',
            'context': {
                'system': 'crewcall',
                'object_name': 'shift',
                'external_id': shift.id
                }
            }
        }
    %}
    {% include 'BisonLabSakonninBundle:Message:_create_check.html.twig' with mconf %}
              <li><a href="#" onClick='createCheck("shiftconfirmcheck");'>Add a must confirm checkbox</a></li>

              <li><a href="#" id="popLogSummary_shift_{{ shift.id }}" data-toggle="popover" data-html="true" onClick="popLogSummary('shift', {{ shift.id }});"> Changes</a></li>
              <li><a href="#" onClick="deleteShift({{ shift.id }});">Delete</a></li>
            </ul>
            </div>
          </td>
        </tr>
        <tr class="jobList" id="jobList_{{ shift.id }}">
        <td colspan="6">
        <div style="float: right">
        <a href="#" onClick="hideJobList({{ shift.id }});"><span class="glyphicon glyphicon-remove-circle"/></a>
        </div>
        <br>
        <div id="jobTable_{{ shift.id }}">
        </div>
        <div id="editShift_{{ shift.id }}" style="float: left">
        </div>
        </td>
        </tr>
    {% endfor %}
    </tbody>
 {% endfor %}
</table>
