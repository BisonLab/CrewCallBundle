{% extends 'base.html.twig' %}
{% block title %}People{% endblock %}

{% block body %}
<script>
function select_all_persons(value) {
    $(".person_list_checkbox").prop('checked', value);
}

function get_selected_persons() {
    list = [];
    $(".person_list_checkbox").each(function(index, box) {
        if ($(box).prop('checked') == true) {
            list.push(box.value);
        }
    });
    return list;
}
</script>

    {% if function_type_plural is defined %}
        <h1>People with {{ function_type_plural }}</h1>
    {% elseif functionEntity is defined and functionEntity is not null %}
        <h1>People with {{ functionEntity }}</h1>
        {% set function_type = null %}
        {% set function_type_label = "Function" %}
    {% else %}
        <h1>People</h1>
        {% set function_type = null %}
        {% set function_type_label = "Function" %}
    {% endif %}
<div class="row">
<div class="col-sm-8">
{% if functions is defined %}
{% if function_type is not null %}
   <form action="{{ path('person_function_type', {'function_type': function_type}) }}" method="GET">
{% else %}
   <form action="{{ path('person_function') }}" method="GET">
{% endif %}
<label>{{ function_type_label }}</label>
<select name="function_id">
    <option value="">All</option>
    {% for elem in functions %}
    <option value="{{ elem.id }}" {% if functionEntity is not null and elem.id == functionEntity.id %}selected{% endif %}>{{ elem.name }}</option>
    {% endfor %}
</select>
    <button class="btn btn-default" type="submit">Show</button>
{% if all is defined and all is not null %}
    <input type="checkbox" name="all" CHECKED>Include non-active</input>
{% else %}
    <input type="checkbox" name="all">Include non-active</input>
{% endif %}
    </form>
{% endif %}
</div>
<div class="col-sm-2">
</div>
<div class="col-sm-2">
    <a href="{{ path('person_new') }}"><button class="btn btn-primary">Add a new person</button></a>
</div>

        <table id="sortable_table" class="table table-striped  table-sm">
        <thead class="thead-inverse">
            <tr>
                <th>Username</th>
                <th>Name</th>
                <th>Functions</th>
                <th>Mobile</th>
                <th>State</th>
{# Undecided               <th>Actions</th> #}
                <th>Select</th>
            </tr>
        </thead>
        <tbody>
        {% for person in people %}
            <tr>
                <td><a href="{{ path('person_show', { 'id': person.id }) }}">{{ person.username }}</a></td>
                <td>{{ person.fullname }}</td>
                <td>
                    {% for f in person.functions(function_type) %} {{ f.name }},{% endfor %}</td>
                <td>{{ person.mobilephonenumber }}</td>
                <td>
                {{ person.state }}
                </td>
{#
                <td>
                  <a href="{{ path('person_show', { 'id': person.id }) }}">Show</a> - 
                  <a href="{{ path('person_edit', { 'id': person.id }) }}">Edit</a>
            {% set mlogcontext = {
                        'system': 'crewcall',
                        'object_name': 'person',
                        'external_id': person.id
                }
            %}
{% if sakonnin_messages.contexthasmessages(mlogcontext) %}
            <br><a href="#" onClick="openMessageLogBox('{{ path('message_context_search', {'access': 'ajax', 'system': mlogcontext.system, 'object_name': mlogcontext.object_name, 'external_id': mlogcontext.external_id }) }}')">Notes</a>
{% endif %}
                </td>
#}
                <td>
                        <input class="person_list_checkbox" type="checkbox" name="person_list" value="{{ person.id }}">
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
<div align="right">
<button class="dababutton" onClick="select_all_persons(true);">Select all</button>
<button class="dababutton" onClick="select_all_persons(false);">Deselect all</button>
</br>
<button class="dababutton" id="message_popover_link" onClick="openMessagePopover(false);">Send a message</button>
</div>

<div align="right">
<div id="message_popover" class="hidden">
<form id="person_list_form" method="POST">
<table>
<textarea name="body" cols="20" rows="4"></textarea><br>
<input type="radio" value="BULKALL" name="message_type" CHECKED>SMS, Email, PM</input><br>
<input type="radio" value="BULKSMS" name="message_type">SMS only</input><br>
<input class="dababutton" id="sendmessage" type="submit" name="submit" value="Send">
</form>
</div>

<script>

function openMessagePopover() {
    content = $("#message_popover").html();
    $( "#message_popover_link" ).popover({
        html: true,
        placement: 'top',
        title: 'Send Message <a href="#" class="close" data-dismiss="alert">&times;</a>',
        content: content
    });
    $( "#message_popover_link" ).popover("show");
    $("#person_list_form").submit(function( event ) {
        var $btn = $(document.activeElement);
        list = get_selected_persons();
        $(".person_list_form_plist").remove();
        list.map(function(value) {
            $("#person_list_form").append('<input class="person_list_form_plist" type="hidden" name="person_list[]" value="'+value+'">');
        });
        if ($btn.is('[id]') && $btn.attr("id") == "sendmessage") {
            postdata = $("#person_list_form").serialize();
            $.ajax({
                type: "POST",
                url: "{{ path('persons_send_message') }}",
                data: postdata,
                success: function(data)
                {
                    alert(data);
                    select_all_persons(false);
                    $( "#message_popover_link" ).popover("hide");
                }
            });
        }
        event.preventDefault();
    });
    $(document).on("click", ".popover .close" , function(){
        $( "#message_popover_link" ).popover("hide");
    });
}
</script>
{% endblock %}
