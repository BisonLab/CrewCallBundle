{% macro print_comboedit(mform, action, message_id, messagetype = "Admin Wall") %}
<div class="modal fade" id="combo_edit_{{ message_id }}" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Edit</h4>
      </div>
      <div class="modal-body">
        <form id="comboform_{{ message_id }}" action="{{ action }}" method="POST" onSubmit="return submitComboForm('{{ action }}', '{{message_id}}');">
        {{ form_row(mform.body)}} 
<span class="hidden">
        {{ form_row(mform.state)}} 
        {{ form_row(mform.message_type)}} 
</span>
        {{ form_row(mform.expire_at)}} 
        <input type="submit" name="submit" value="Save">
        {{ form_widget(mform._token)}} 
        </form>
    </div>
  </div>
 </div>
</div>
{% endmacro %}
{% import _self as cmac %}

{% include 'CrewCallBundle:dashboarder:handling.html.twig' %}

<div id="combowall">
<div class="row">
<div class="col-sm-10">
<h3>Notes</h3>
</div>
<div class="col-sm-1" style="margin-top: 20px;">
 <a href="#" onClick='createCombo();' class="btn btn-xs btn-dark">Add</a>
</div>
</div>

{% set criterias = {
    'message_types': ['Admin Wall', 'TODO'],
    'states': ['UNREAD', 'UNCHECKED', 'CHECKED', 'SHOW'],
    }
%}
{% for message in sakonnin_messages.messages(criterias) %}
 {% if is_granted('show', message) %}
  {% if message.messagetype == "TODO" %}
   <div id="sakonninmcheck{{ message.id}}">
  {% else %}
   <div id="sakonninmessage_{{ message.id}}">
  {% endif %}
     <div class="row ccNotesText">
<pre wrap class="ccNotesText col-md-8">
{{ message.body }}
</pre>
        <div class="col-md-2">
        <br>
        {% if message.messagetype == "TODO" %}
            <label class="cc_switch">
              <input type="checkbox" id="todocheck_{{ message.id }}" onChange="setCheckboxState({{ message.id }}, this)" {% if message.state == "CHECKED" %}checked{% endif %}/>
              <span class="cc_slider round"></span>
            </label><br>
        {% else %}
            <a href="#" onClick="return setStateOnMessage({{ message.id }}, 'ARCHIVED');" class="btn btn-xs btn-success">Archive</a><br>
        {% endif %}
        </div>
        <div class="col-md-1">
        <br>
        {% if is_granted('edit', message) %}
{% set emform = sakonnin_messages.getEditForm( message, true ) %}
{% set action = path('message_edit', { 'id': message.id, 'access': 'ajax' }) %}
{{ cmac.print_comboedit(emform, action, message.id, message.messagetype ) }}
            <a href="#" onClick='editCombo({{ message.id }});' class="btn btn-xs btn-dark">Edit</a>
        {% endif %}
        </div>
     </div>
   </div>
 {% endif %}
{% endfor %}

 <div class="modal fade" id="createcombo" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Add todo or wall message</h4>
      </div>
      <div class="modal-body">
        <label class="cc_switch">
        <input type="checkbox" id="mtypecheck" onChange="setMessageType(this)" />
        <span class="cc_slider round"></span>
        </label>
        <strong>Todo</strong>
{% set ccmform = sakonnin_messages.getCreateForm({
    'message_data': {},
    'create_view': true,
    'formname': 'createcomboform'
 }) %}
        <form id="createcomboform" action="{{ path('message_create', { 'access': 'ajax' }) }}" method="POST" onSubmit="return submitCreateComboForm();">
        {{ form_row(ccmform.body)}} 
        <span class="hidden">
        {{ form_row(ccmform.state)}} 
        {{ form_row(ccmform.message_type)}} 
        </span>
        {{ form_row(ccmform.expire_at)}} 
        <input type="submit" name="submit" value="Save">
        {{ form_widget(ccmform._token)}} 
        </form>
      </div>
    </div>
  </div>
 </div>
</div> <!-- end combowall -->

<script type="text/javascript">

function setCheckboxState(message_id, elem) {
    if (elem.checked) {
        setStateOnMessage(message_id, "CHECKED");
    } else {
        setStateOnMessage(message_id, "UNCHECKED");
    }
}

$(document).ready(function() {
    $( "#message_data_message_type" ).val({{ sakonnin_messages.messagetype('Admin Wall').id }});
} );

function createCombo() {
    $( "#createcombo").modal();
    return false;
}

function editCombo(message_id) {
    $( "#combo_edit_" + message_id).modal();
    return false;
}

function submitComboForm(action_url, message_id) {
    formdata = $( "#comboform_" + message_id).serialize();
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        type: "POST",
        url: "{{ path('message_create', { 'access': 'ajax' }) }}",
        data: formdata,
        dataType: "text",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            $( "#combo_edit_" + message_id ).modal("hide");
            parent.location.reload();
      }).fail(function(xhr, status, error) {
            errmsg = "Combo sending failed\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}

function setMessageType(elem) {
    if (elem.checked) {
        $( "#createcomboform #message_data_message_type" ).val({{ sakonnin_messages.messagetype('TODO').id }});
    } else {
        $( "#createcomboform #message_data_message_type" ).val({{ sakonnin_messages.messagetype('Admin Wall').id }});
    }
}

/*
 * I should not need this one, but I have up on getting create and edit work
 * together, the Save button did nothing unless I did this.
 */
function submitCreateComboForm() {
    formdata = $( "#createcomboform" ).serialize();
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        type: "POST",
        url: "{{ path('message_create', { 'access': 'ajax' }) }}",
        data: formdata,
        dataType: "text",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            $( "#createcombo" ).modal("hide");
            parent.location.reload();
      }).fail(function(xhr, status, error) {
            errmsg = "Combo sending failed\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}
</script>
