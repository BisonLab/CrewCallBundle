<script>

function grabJobList(shift_id) {
    url = "{{ path('job_index', {'access': 'ajax' }) }}" 
        + "?shift=" + shift_id;
    $.get(url, function( data ) {
        $( "#jobTable_" + shift_id ).html(data);
        $( "#jobList_" + shift_id ).show();
        $( "#plus_job_list_" + shift_id ).hide();
        $( "#minus_job_list_" + shift_id ).show();
    });
    return false;
}

function hideJobList(shift_id) {
    $( "#jobList_" + shift_id ).hide();
    $( "#plus_job_list_" + shift_id ).show();
    $( "#minus_job_list_" + shift_id ).hide();
}

function setStateOnJob(job_id, state, shift_id) {
    cheat_url = "{{ path('job_state', { 'id': 0, 'state': 'NONE', 'access': 'ajax' }) }}";
    c_url = cheat_url.replace("0", job_id);
    url = c_url.replace("NONE", state);
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        url: url,
        type: "POST",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            if ($( "#jobTable_" + shift_id ).length) {
                grabJobList(shift_id);
            } else {
                parent.location.reload();
            }
      }).fail(function(xhr, status, error) {
            errmsg = "Warning!\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
            if ($( "#jobTable_" + shift_id ).length) {
                grabJobList(shift_id);
            } else {
                parent.location.reload();
            }
    });
    return false;
}

function grabNewJobForm(shift_id) {
    url = "{{ path('job_new', { 'access': 'ajax' }) }}";
    if (shift_id) {
        url = url + "?shift=" + shift_id;
    }
    $.get(url, function( data ) {
        $( "#newJob"+shift_id ).html(data);
        $( "#jobList_" + shift_id ).show();
        $( "#newShiftOrganization_"+shift_id).hide();
        $( "#crewcallbundle_job_shift").prev().hide();
        $( "#crewcallbundle_job_shift").hide();
        $( "#newJob"+shift_id ).submit(function( event ) {
            event.preventDefault();
            submitNewJobForm(shift_id);
        });
        $( "#crewcallbundle_job_person" ).autocomplete({
          source: "{{ path('person_search', {'enabled': true, 'access': 'ajax'}) }}",
          minLength: 2,
          select: function( event, ui ) {
            $( "#newJobForm #crewcallbundle_job_person" ).val(ui.item.value);
            $( "#newJobForm #username" ).val(ui.item.username);
          }
         });
    });
    return false;
}

function submitNewJobForm(shift_id) {
    username = $( "#newJobForm #username" ).val();
    $( "#newJobForm #crewcallbundle_job_person" ).val(username);
    newJobFormData = $( "#newJobForm" ).serialize();
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        type: "POST",
        url: "{{ path('job_new', { 'access': 'ajax' }) }}",
        data: newJobFormData,
        dataType: "text",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            if (xhr.status == 201) {
                // Gotta reload. Easiest way to recount everything.
                parent.location.reload();
            } else {
                $( "#newJob"+shift_id ).html(xhr.responseText);
            }
      }).fail(function(xhr, status, error) {
            errmsg = "Failed adding new job\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}
</script>
