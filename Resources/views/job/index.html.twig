{% set joblog_token = joblog_form._token.vars.value %}
{% set joblog_start = form_start(joblog_form) %}
<script>

$(document).ready(function(){
    $('[data-toggle="popover"]').popover();   
    $("[data-toggle='popover']").on('shown.bs.popover', function(element){
    var popoverid = $( element.target ).attr( "aria-describedby" );

    $( "#" + popoverid + " #newJobLogForm").submit(function( event ) {
console.log("Booo");
            event.preventDefault();
            submitNewJobLog2(popoverid);
        });
    });
});

function submitNewJobLog2(popoverid) {
    var formobject = $( "#" + popoverid + " #newJobLogForm");
console.log(formobject.serialize());
    var newJobFormLogData = $.param(formobject);
console.log(newJobFormLogData);
    var job_id = newJobFormLogData['crewcallbundle_joblog_job'];
    var shift_id = $( "#" + popoverid + " #div_shift_id").val();
    console.log(job_id);
    console.log(shift_id);
}

function submitNewJobLog(job_id, shift_id) {
    var newJobFormLogData = $( "#newJobLogForm_" + job_id ).serialize();
    console.log(newJobFormLogData);
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        type: "POST",
        url: "{{ path('job_joblog_new', { 'access': 'ajax' }) }}",
        data: newJobFormLogData,
        dataType: "text",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            if (xhr.status == 201) {
                // Gotta reload. Easiest way to recount everything.
                // parent.location.reload();
                grabJobList(shift_id);
            } else {
                $( "#newJobLog"+job_id ).html(xhr.responseText);
            }
      }).fail(function(xhr, status, error) {
            errmsg = "Message sending failed\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}

</script>
<table id="jobTable" class="table table-bordered table-sm">
    <thead>
        <tr>
            <th>Person</th>
            <th>State</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for job in jobs %}
        <tr>
            <td>
            {{ job.person }}
{% set mlogcontext = {
            'system': 'crewcall',
            'object_name': 'person',
            'external_id': job.person.id
    }
%}
{% if sakonnin_messages.contexthasmessages(mlogcontext) %}
            &nbsp;(<a href="#" onClick="openMessageLogBox('{{ path('message_context_search', {'access': 'ajax', 'system': mlogcontext.system, 'object_name': mlogcontext.object_name, 'external_id': mlogcontext.external_id }) }}')">Notes</a>)
{% endif %}
            </td>
            <td>{{ job.state }}</td>
            <td>
            {% if not job.booked %}
                {% if job.state != "ASSIGNED" %}
              <a role="button" class="btn btn-success" href="#" onClick="setStateOnJob({{job.id}}, 'ASSIGNED', {{ job.shift.id }});">Assign</a>
                {% endif %}
              <a role="button" class="btn btn-success" href="#" onClick="setStateOnJob({{job.id}}, 'CONFIRMED', {{ job.shift.id }});">Confirm</a>
              <a role="button" class="btn btn-danger" href="#" onClick="setStateOnJob({{job.id}}, 'DENIED', {{ job.shift.id }});">Deny</a>
            {% else %}
              <a role="button" class="btn btn-danger" href="#" onClick="setStateOnJob({{job.id}}, 'INTERESTED', {{ job.shift.id }});">Release</a>
            {% endif %}
            {% if job.state != "COMPLETED" and job.shift.end < date() %}
{% set popcontent = 
    '<div id="newJobLog_' ~ job.id ~ '">'
    ~ '<form id="newJobLogForm">'
    ~ 'In: <input type="text" size="16" name="crewcallbundle_joblog_in_date" value="' ~ job.shift.start | date("Y-m-d H:i") ~ '"><br>'
    ~ 'Out: <input type="text" size="16" name="crewcallbundle_joblog_out_date" value="' ~ job.shift.end | date("Y-m-d H:i") ~ '"><br>'
    ~ '<input type="hidden" name="_token" value="' ~ joblog_token ~ '">' 
    ~ '<input type="hidden" name="shift_id" value="' ~ job.shift.id ~ '">' 
    ~ '<input type="hidden" name="crewcallbundle_joblog_job" value="' ~ job.id ~ '">' 
    ~ '<input type="submit" value="Add">' 
    ~ '</form></div>'
%}
{#
    ~ '<form id="newJobLogForm_' ~ job.id ~ '">'
    ~ '<input type="submit" class="btn btn-success" onClick="submitNewJobLog(' ~ job.id ~ ',' ~ job.shift.id ~ ');" value="Add">' 
    ~ '<button class="btn btn-success" onClick="submitNewJobLog(' ~ job.id ~ ',' ~ job.shift.id ~ ');" name="">Add</button>' 
#}
                <a href="#" data-html="true" data-toggle="popover" data-placement="left" title="Log work" data-content='{{ popcontent }}'>Log work</a><br>
            {% endif %}
            </td>
        </tr>
    {% endfor %}
    {% if sos.count > 0 %}
        </tbody>
        <thead>
            <tr>
                <th>Organization</th>
                <th>Amount</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for so in sos %}
          <tr>
            <td>{{ so.organization }}</td>
            <td>{{ so.amount }}</td>
            <td>
              <a role="button" class="btn btn-danger" href="#" onClick="deleteShiftOrganization({{so.id}});">Delete</a>
            </td>
          </tr>
        {% endfor %}
    {% endif %}
    </tbody>
</table>
